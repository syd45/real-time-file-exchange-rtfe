const WebSocket = require("ws");\nconst fs = require("fs");\nconst path = require("path");\n\n// 测试配置\nconst SERVER_URL = "ws://localhost:3000";\nconst TEST_FILE_PATH = "./test_subscription.txt";\n\nconsole.log("Starting SDAV subscription functionality test...");\n\n// 连接到WebSocket服务器\nconst ws = new WebSocket(SERVER_URL, {\n  headers: {\n    "Authorization": "Basic " + Buffer.from("admin:password").toString("base64")\n  }\n});\n\nws.on("open", () => {\n  console.log("Connected to WebSocket server");\n\n  // 测试1: 订阅根目录\n  console.log("\\nTest 1: Subscribing to root directory (/)");\n  ws.send(JSON.stringify({\n    type: "subscribe",\n    path: "/"\n  }));\n\n  // 等待一段时间后创建测试文件\n  setTimeout(() => {\n    console.log("\\nCreating test file...");\n    fs.writeFileSync(TEST_FILE_PATH, "Test content for subscription");\n    console.log("Test file created");\n  }, 2000);\n\n  // 等待一段时间后取消订阅\n  setTimeout(() => {\n    console.log("\\nTest 2: Unsubscribing from root directory (/)");\n    ws.send(JSON.stringify({\n      type: "unsubscribe",\n      path: "/"\n    }));\n  }, 5000);\n\n  // 等待一段时间后再次创建文件（应该不会收到通知）\n  setTimeout(() => {\n    console.log("\\nCreating another test file (should not receive notification)...");\n    fs.writeFileSync("./test_subscription2.txt", "Second test content");\n    console.log("Second test file created");\n  }, 7000);\n\n  // 测试3: 订阅特定目录\n  setTimeout(() => {\n    console.log("\\nTest 3: Subscribing to specific directory (/testdir/**)");\n    // 创建测试目录\n    if (!fs.existsSync("./testdir")) {\n      fs.mkdirSync("./testdir");\n    }\n    \n    ws.send(JSON.stringify({\n      type: "subscribe",\n      path: "/testdir/**"\n    }));\n  }, 10000);\n\n  // 测试在订阅目录中创建文件\n  setTimeout(() => {\n    console.log("\\nCreating file in subscribed directory...");\n    fs.writeFileSync("./testdir/test_nested.txt", "Nested test content");\n    console.log("Nested test file created");\n  }, 12000);\n\n  // 测试获取订阅列表\n  setTimeout(() => {\n    console.log("\\nTest 4: Getting current subscriptions");\n    ws.send(JSON.stringify({\n      type: "getSubscriptions"\n    }));\n  }, 15000);\n\n  // 测试5: 订阅特定文件\n  setTimeout(() => {\n    console.log("\\nTest 5: Subscribing to specific file (/test_subscription.txt)");\n    ws.send(JSON.stringify({\n      type: "subscribe",\n      path: "/test_subscription.txt"\n    }));\n  }, 18000);\n\n  // 修改已订阅的文件\n  setTimeout(() => {\n    console.log("\\nModifying subscribed file...");\n    fs.appendFileSync(TEST_FILE_PATH, "\\nAdditional content");\n    console.log("Subscribed file modified");\n  }, 20000);\n\n  // 最后清理测试文件\n  setTimeout(() => {\n    console.log("\\nCleaning up test files...");\n    if (fs.existsSync(TEST_FILE_PATH)) {\n      fs.unlinkSync(TEST_FILE_PATH);\n    }\n    if (fs.existsSync("./test_subscription2.txt")) {\n      fs.unlinkSync("./test_subscription2.txt");\n    }\n    if (fs.existsSync("./testdir/test_nested.txt")) {\n      fs.unlinkSync("./testdir/test_nested.txt");\n    }\n    if (fs.existsSync("./testdir")) {\n      fs.rmdirSync("./testdir");\n    }\n    console.log("Cleanup completed");\n  }, 25000);\n\n  // 关闭连接\n  setTimeout(() => {\n    console.log("\\nClosing WebSocket connection...");\n    ws.close();\n  }, 30000);\n});\n\nws.on("message", (data) => {\n  const message = JSON.parse(data.toString());\n  console.log("Received message from server:", message);\n});\n\nws.on("close", () => {\n  console.log("\\nWebSocket connection closed");\n  console.log("Test completed!");\n});\n\nws.on("error", (error) => {\n  console.error("WebSocket error:", error);\n});
